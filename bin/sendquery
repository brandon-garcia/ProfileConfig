#!/usr/bin/expect -f
set timeout -1

proc getauth {host dbtype database} {
	spawn bash
	expect -re {[^ ] $}
	set auth_data [split [exec auth -h $host -t $dbtype -d $database] "\n"]
	send "exit\r"
	return $auth_data
}

proc sshlogin {host password} {
	spawn ssh $host
	expect {
			{assword: }        { send "$password\r" ; exp_continue }
		-re {[^a-zA-Z_0-9 ] $} {                                   }
		-re {[^a-zA-Z_0-9 ]$}  {                                   }
	}
	return $spawn_id
}

set ssh_host [lindex $argv 0]
set db_type  [lindex $argv 1]
set db_name  [lindex $argv 2]
set query    [lindex $argv 3]

set auth_data [getauth $ssh_host $db_type $db_name]
set ssh_pass  [lindex $auth_data 0]
set db_cmd    [lindex $auth_data 1]
set db_pass   [lindex $auth_data 2]

set spawn_id [sshlogin $ssh_host $ssh_pass]
expect -re {[$∫] } { exp_send "$db_cmd -e \"$query;\"\r" }
expect -re {[$∫] } { exp_send "exit\r" }
send_user "\n"
